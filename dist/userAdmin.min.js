/*! userAdmin 02-12-2014 */
function getLogger(a){var b=a.filename.split("/").slice(-2).join("/");return new winston.Logger({transports:[new winston.transports.Console({colorize:!0,level:"debug",label:b})]})}!function(){"use strict";{var a=require("../libs/config"),b=require("passport"),c=require("passport-http").BasicStrategy,d=require("passport-oauth2-client-password").Strategy,e=require("passport-http-bearer").Strategy,f=require("../models/users").UserModel,g=require("../models/client").ClientModel,h=require("../models/accessToken").AccessTokenModel;require("../models/refreshToken").RefreshTokenModel}b.use(new c(function(a,b,c){g.findOne({clientId:a},function(a,d){return a?c(a):d?d.clientSecret!=b?c(null,!1):c(null,d):c(null,!1)})})),b.use(new d(function(a,b,c){g.findOne({clientId:a},function(a,d){return a?c(a):d?d.clientSecret!=b?c(null,!1):c(null,d):c(null,!1)})})),b.use(new e(function(b,c){h.findOne({token:b},function(d,e){return d?c(d):e?Math.round((Date.now()-e.created)/1e3)>a.get("security:tokenLife")?(h.remove({token:b},function(a){return a?c(a):void 0}),c(null,!1,{message:"Token expired"})):void f.findById(e.userId,function(a,b){if(a)return c(a);if(!b)return c(null,!1,{message:"Unknown user"});var d={scope:"*"};c(null,b,d)}):c(null,!1)})}))}(module),function(a){"use strict";function b(a,b){var d={isValid:null,messages:[],clientId:null},e=new c(a);c.findOne({name:a.name},function(a,c){a&&b(a),c?(d.isValid=!1,d.messages.push("Client already exists"),b(null,d)):e.save(function(a,c){a?b(a):(d.isValid=!0,d.clientId=c.clientId,d.messages.push("Client created"),b(null,d))})})}var c=(require("../libs/log")(a),require("../models/client").ClientModel);exports.create=b,exports.postClients=function(a,c,d){b(a.body,function(a,b){a?d(a):c.json(b)})}}(module),function(a){"use strict";a.exports.setRoutes=function(a,b){a.use(function(a,c){b.info("Not found URL: %s",a.url),c.status(404),c.send({})}),a.use(function(a,c,d,e){return a?(console.log(a.message),console.log(a.stack),b.error(a),d.status(a.status||500),void d.send({})):e()})},a.exports.setAccessControlOrigin=function(a){a.use(function(a,b,c){b.setHeader("Access-Control-Allow-Origin","*"),b.setHeader("Access-Control-Allow-Methods","GET, POST, OPTIONS, PUT, PATCH, DELETE"),b.setHeader("Access-Control-Allow-Headers","X-Requested-With,content-type"),b.setHeader("Access-Control-Allow-Credentials",!0),b.setHeader("Access-Control-Allow-Headers","Authorization"),c()})}}(module),function(a){"use strict";a.exports.setRoutes=function(a){a.get("/",function(a,b){b.sendFile("public/index.html",{root:__dirname})})}}(module),function(a){"use strict";var b=(require("mongoose"),require("oauth2orize")),c=require("passport"),d=require("crypto"),e=require("../libs/config"),f=require("../models/users").UserModel,g=require("../models/accessToken").AccessTokenModel,h=require("../models/refreshToken").RefreshTokenModel,i=b.createServer(),j=function(a,b){return b?a(b):void 0},k=function(a,b){var c,f,i,k,l=j.bind(void 0,b);h.remove(a,l),g.remove(a,l),k=d.randomBytes(32).toString("base64"),f=d.randomBytes(32).toString("base64"),a.token=k,i=new g(a),a.token=f,c=new h(a),c.save(l),i.save(function(a){return a?b(a):void b(null,k,f,{expires_in:e.get("security:tokenLife")})})};i.exchange(b.exchange.password(function(a,b,c,d,e){f.findOne({username:b},function(b,d){if(b)return e(b);if(!d||!d.checkPassword(c))return e(null,!1);var f={userId:d.userId,clientId:a.clientId};k(f,e)})})),i.exchange(b.exchange.refreshToken(function(a,b,c,d){h.findOne({token:b,clientId:a.clientId},function(b,c){return b?d(b):c?void f.findById(c.userId,function(b,c){if(b)return d(b);if(!c)return d(null,!1);var e={userId:c.userId,clientId:a.clientId};k(e,d)}):d(null,!1)})})),a.exports.isAuthenticated=c.authenticate("bearer",{session:!1}),a.exports.setRoutes=function(a){a.post("/oauth/token",[c.authenticate(["basic","oauth2-client-password"],{session:!1}),i.token(),i.errorHandler()])}}(module),function(a){"use strict";function b(a,b){var d=new c(a),e={isValid:null,messages:[],userId:null};c.findOne({username:d.username},function(a,c){a&&b(a),c?(e.isValid=!1,e.messages.push("User already exists"),b(null,e)):d.save(function(a,c){a?b(a):(e.isValid=!0,e.userId=c.userId,e.messages.push("User created"),b(null,e))})})}var c=(require("../libs/log")(a),require("../models/users").UserModel);a.exports.create=b,a.exports.setRoutes=function(a,c){a.get("/api/user",c.isAuthenticated,function(a,b){b.json({user_id:a.user.userId,name:a.user.username,scope:a.authInfo.scope})}),a.post("/api/user",function(a,c,d){b(a.body,function(a,b){a?d(a):c.json(b)})})}}(module);var config=require("nconf"),p="src/config.json";console.log(p),config.argv().env().file({file:p}),module.exports=config;var mongoose=require("mongoose"),log=require("../libs/log")(module),config=require("../libs/config");mongoose.connect(process.env.CUSTOMCONNSTR_MONGOLAB_URI||config.get("mongoose:uri"));var db=mongoose.connection;db.on("error",function(a){log.error("connection error:",a.message)}),db.once("open",function(){log.info("Connected to DB!")}),module.exports.mongoose=mongoose;var winston=require("winston");module.exports=getLogger;var mongoose=require("mongoose"),Schema=mongoose.Schema,AccessToken=new Schema({userId:{type:String,required:!0},clientId:{type:String,required:!0},token:{type:String,unique:!0,required:!0},created:{type:Date,"default":Date.now}});module.exports.AccessTokenModel=mongoose.model("AccessToken",AccessToken);var mongoose=require("mongoose"),Schema=mongoose.Schema,Client=new Schema({name:{type:String,unique:!0,required:!0},clientId:{type:String,unique:!0,required:!0},clientSecret:{type:String,required:!0}});module.exports.ClientModel=mongoose.model("Client",Client);var mongoose=require("mongoose"),Schema=mongoose.Schema,RefreshToken=new Schema({userId:{type:String,required:!0},clientId:{type:String,required:!0},token:{type:String,unique:!0,required:!0},created:{type:Date,"default":Date.now}});module.exports.RefreshTokenModel=mongoose.model("RefreshToken",RefreshToken);var mongoose=require("mongoose"),log=require("../libs/log")(module),config=require("../libs/config"),crypto=require("crypto"),Schema=mongoose.Schema,User=new Schema({username:{type:String,unique:!0,required:!0},hashedPassword:{type:String,required:!0},salt:{type:String,required:!0},created:{type:Date,"default":Date.now}});User.methods.encryptPassword=function(a){return crypto.createHmac("sha1",this.salt).update(a).digest("hex")},User.virtual("userId").get(function(){return this.id}),User.virtual("password").set(function(a){this._plainPassword=a,this.salt=crypto.randomBytes(32).toString("base64"),this.hashedPassword=this.encryptPassword(a)}).get(function(){return this._plainPassword}),User.methods.checkPassword=function(a){return this.encryptPassword(a)===this.hashedPassword},module.exports.UserModel=mongoose.model("User",User),function(a){"user strict";var b=require("express"),c=require("serve-favicon"),d=require("method-override"),e=require("path"),f=require("passport"),g=require("body-parser"),h=require("./libs/config"),i=(require("./libs/db").mongoose,require("./libs/log")(a)),j=require("./controllers/oauth2"),k=(require("./controllers/auth"),require("./controllers/home")),l=require("./controllers/client"),m=require("./controllers/users"),n=require("./controllers/common"),o=b();o.set("port",process.env.PORT||h.get("port")),o.use(c(__dirname+"/public/favicon.ico")),o.use(g.urlencoded({extended:!0})),o.use(g.json()),o.use(f.initialize()),o.use(d("X-HTTP-Method-Override")),o.use(b.static(e.join(__dirname,"public"))),("test"===process.env.NODE_ENV||"dev"===process.env.NODE_ENV)&&(n.setAccessControlOrigin(o),o.post("/api/client",l.postClients)),k.setRoutes(o),j.setRoutes(o),m.setRoutes(o,j),n.setRoutes(o,i),process.on("uncaughtException",function(a){try{i.error(a)}catch(b){try{i.error(a)}catch(c){}}process.exit(1)}),o.listen(o.get("port"),function(){i.info("Express server listening on port "+o.get("port"))})}(module);